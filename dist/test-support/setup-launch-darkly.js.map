{"version":3,"file":"setup-launch-darkly.js","sources":["../../src/test-support/setup-launch-darkly.ts"],"sourcesContent":["import type ApplicationInstance from '@ember/application/instance';\nimport { settled } from '@ember/test-helpers';\nimport type { TestContext } from '@ember/test-helpers';\nimport type { setupTest } from 'ember-qunit';\n\nimport {\n  default as Context,\n  getCurrentContext,\n  setCurrentContext,\n} from '../-sdk/context.ts';\nimport type { InitStatus } from '../-sdk/context.ts';\nimport type { EmberLaunchDarklyOptions } from '../-sdk/initialize.ts';\n\ntype NestedHooks = Parameters<typeof setupTest>[0];\ninterface LDTestContext extends TestContext {\n  withVariation?: (key: string, value: boolean) => Promise<void>;\n  withInitStatus?: (status: InitStatus, error?: unknown) => Promise<void>;\n}\n\nexport default function setupLaunchDarkly(hooks: NestedHooks) {\n  hooks.beforeEach(function (this: LDTestContext) {\n    if (!this.owner) {\n      throw new Error(\n        'You must call one of the ember-qunit setupTest(), setupRenderingTest() or setupApplicationTest() methods before calling setupLaunchDarkly()',\n      );\n    }\n\n    const owner = this.owner as ApplicationInstance;\n    const config = owner.resolveRegistration('config:environment') as {\n      launchDarkly: EmberLaunchDarklyOptions;\n    };\n    let { localFlags } = {\n      localFlags: {},\n      ...(config?.launchDarkly || {}),\n    } as { localFlags: Record<string, unknown> };\n\n    localFlags = Object.keys(localFlags).reduce((acc, key) => {\n      // @ts-expect-error TODO: fix this type error\n      acc[key] = false;\n\n      return acc;\n    }, {});\n\n    const context = new Context({ flags: localFlags });\n\n    setCurrentContext(context);\n\n    this.withVariation = (key, value = true) => {\n      const context = getCurrentContext();\n\n      if (!context) {\n        throw new Error(\n          'LaunchDarkly context is missing. Ensure `setupLaunchDarkly` has initialized correctly.',\n        );\n      }\n\n      context.set(key, value);\n\n      return settled();\n    };\n\n    /**\n     * Simulate a specific initialization status in tests.\n     *\n     * Useful for testing degraded-state UI when LaunchDarkly fails to\n     * initialize.\n     *\n     * @example\n     * ```js\n     * await this.withInitStatus('failed', new Error('timeout'));\n     * // Now context.initStatus === 'failed' and context.initError is the Error\n     * ```\n     */\n    this.withInitStatus = (status: InitStatus, error?: unknown) => {\n      const context = getCurrentContext();\n\n      if (!context) {\n        throw new Error(\n          'LaunchDarkly context is missing. Ensure `setupLaunchDarkly` has initialized correctly.',\n        );\n      }\n\n      context.transitionStatus(status, error);\n\n      return settled();\n    };\n  });\n\n  hooks.afterEach(async function (this: LDTestContext) {\n    const context = getCurrentContext();\n\n    await context?.destroy();\n    await settled();\n    delete this.withVariation;\n    delete this.withInitStatus;\n  });\n}\n"],"names":["setupLaunchDarkly","hooks","beforeEach","owner","Error","config","resolveRegistration","localFlags","launchDarkly","Object","keys","reduce","acc","key","context","Context","flags","setCurrentContext","withVariation","value","getCurrentContext","set","settled","withInitStatus","status","error","transitionStatus","afterEach","destroy"],"mappings":";;;AAmBe,SAASA,iBAAiBA,CAACC,KAAkB,EAAE;EAC5DA,KAAK,CAACC,UAAU,CAAC,YAA+B;AAC9C,IAAA,IAAI,CAAC,IAAI,CAACC,KAAK,EAAE;AACf,MAAA,MAAM,IAAIC,KAAK,CACb,6IACF,CAAC;AACH,IAAA;AAEA,IAAA,MAAMD,KAAK,GAAG,IAAI,CAACA,KAA4B;AAC/C,IAAA,MAAME,MAAM,GAAGF,KAAK,CAACG,mBAAmB,CAAC,oBAAoB,CAE5D;IACD,IAAI;AAAEC,MAAAA;AAAW,KAAC,GAAG;MACnBA,UAAU,EAAE,EAAE;AACd,MAAA,IAAIF,MAAM,EAAEG,YAAY,IAAI,EAAE;KACY;AAE5CD,IAAAA,UAAU,GAAGE,MAAM,CAACC,IAAI,CAACH,UAAU,CAAC,CAACI,MAAM,CAAC,CAACC,GAAG,EAAEC,GAAG,KAAK;AACxD;AACAD,MAAAA,GAAG,CAACC,GAAG,CAAC,GAAG,KAAK;AAEhB,MAAA,OAAOD,GAAG;IACZ,CAAC,EAAE,EAAE,CAAC;AAEN,IAAA,MAAME,OAAO,GAAG,IAAIC,OAAO,CAAC;AAAEC,MAAAA,KAAK,EAAET;AAAW,KAAC,CAAC;IAElDU,iBAAiB,CAACH,OAAO,CAAC;IAE1B,IAAI,CAACI,aAAa,GAAG,CAACL,GAAG,EAAEM,KAAK,GAAG,IAAI,KAAK;AAC1C,MAAA,MAAML,OAAO,GAAGM,iBAAiB,EAAE;MAEnC,IAAI,CAACN,OAAO,EAAE;AACZ,QAAA,MAAM,IAAIV,KAAK,CACb,wFACF,CAAC;AACH,MAAA;AAEAU,MAAAA,OAAO,CAACO,GAAG,CAACR,GAAG,EAAEM,KAAK,CAAC;MAEvB,OAAOG,OAAO,EAAE;IAClB,CAAC;;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACI,IAAA,IAAI,CAACC,cAAc,GAAG,CAACC,MAAkB,EAAEC,KAAe,KAAK;AAC7D,MAAA,MAAMX,OAAO,GAAGM,iBAAiB,EAAE;MAEnC,IAAI,CAACN,OAAO,EAAE;AACZ,QAAA,MAAM,IAAIV,KAAK,CACb,wFACF,CAAC;AACH,MAAA;AAEAU,MAAAA,OAAO,CAACY,gBAAgB,CAACF,MAAM,EAAEC,KAAK,CAAC;MAEvC,OAAOH,OAAO,EAAE;IAClB,CAAC;AACH,EAAA,CAAC,CAAC;EAEFrB,KAAK,CAAC0B,SAAS,CAAC,kBAAqC;AACnD,IAAA,MAAMb,OAAO,GAAGM,iBAAiB,EAAE;AAEnC,IAAA,MAAMN,OAAO,EAAEc,OAAO,EAAE;IACxB,MAAMN,OAAO,EAAE;IACf,OAAO,IAAI,CAACJ,aAAa;IACzB,OAAO,IAAI,CAACK,cAAc;AAC5B,EAAA,CAAC,CAAC;AACJ;;;;"}