{"version":3,"file":"initialize.js","sources":["../../src/-sdk/initialize.ts"],"sourcesContent":["import { warn } from '@ember/debug';\n\nimport * as LDClient from 'launchdarkly-js-client-sdk';\n\nimport Context, { getCurrentContext, setCurrentContext } from './context.ts';\nimport type { InitStatus, OnStatusChange, OnError } from './context.ts';\n\ndeclare const __ADDON_VERSION__: string;\n\ntype StreamingConfig = { allExcept?: Array<string>; [key: string]: unknown };\n\nexport interface EmberLaunchDarklyOptions extends Omit<\n  LDClient.LDOptions,\n  'bootstrap'\n> {\n  bootstrap?: 'localFlags' | LDClient.LDOptions['bootstrap'];\n  localFlags?: Record<string, unknown>;\n  mode?: string;\n  sendEventsOnlyForVariation?: boolean;\n  streamingFlags?: boolean;\n\n  /**\n   * Timeout in seconds for `waitForInitialization()`. If the SDK does not\n   * initialize within this time, the promise will be rejected and the app\n   * will continue with bootstrap/default flag values.\n   *\n   * @default 5\n   */\n  timeout?: number;\n\n  /**\n   * Callback invoked when the initialization status changes.\n   *\n   * Most useful for reacting to post-init **recovery**: when the LD SDK\n   * reconnects after a failed initialization, the callback fires with\n   * `('initialized', 'failed')`.\n   *\n   * @example\n   * ```ts\n   * await initialize(clientSideId, user, {\n   *   onStatusChange(newStatus, previousStatus) {\n   *     if (newStatus === 'initialized' && previousStatus === 'failed') {\n   *       console.log('LaunchDarkly recovered!');\n   *     }\n   *   },\n   * });\n   * ```\n   */\n  onStatusChange?: OnStatusChange;\n\n  /**\n   * Callback invoked when the LD SDK emits a runtime error (e.g. stream\n   * disconnection, network failure).\n   *\n   * If not provided, errors are logged via `@ember/debug`'s `warn()`. The\n   * most recent error is always available on `context.lastError`.\n   */\n  onError?: OnError;\n}\n\n/**\n * Result returned by `initialize()`.\n *\n * Consumers can inspect this to decide how to handle initialization failures\n * without relying on try/catch.\n *\n * @example\n * ```ts\n * const result = await initialize(clientSideId, user, {\n *   mode: 'remote',\n *   timeout: 5,\n * });\n *\n * if (!result.isOk) {\n *   console.error('LD init failed:', result.error);\n * }\n * ```\n */\nexport interface InitializeResult {\n  /** Whether initialization completed successfully (`true` for both remote success and local mode). */\n  isOk: boolean;\n\n  /** How initialization completed: `'initialized'`, `'failed'`, or `'local'`. */\n  status: InitStatus;\n\n  /** The error from `waitForInitialization()` if it failed, otherwise `undefined`. */\n  error?: unknown;\n\n  /** The LaunchDarkly context. Use this to access reactive state, SDK passthroughs, etc. */\n  context: Context<Record<string, unknown>>;\n}\n\nexport function shouldUpdateFlag(\n  key: string,\n  streamingConfig?: StreamingConfig | boolean,\n) {\n  if (streamingConfig === true) {\n    return true;\n  }\n\n  if (streamingConfig && typeof streamingConfig === 'object') {\n    if (streamingConfig.allExcept != null) {\n      if (Array.isArray(streamingConfig.allExcept)) {\n        return !streamingConfig.allExcept.includes(key);\n      }\n\n      return false;\n    }\n\n    if (streamingConfig[key] && typeof streamingConfig[key] === 'boolean') {\n      return streamingConfig[key];\n    }\n  }\n\n  return false;\n}\n\nexport async function initialize(\n  clientSideId: string,\n  user = {},\n  options: EmberLaunchDarklyOptions = {},\n): Promise<InitializeResult> {\n  try {\n    if (getCurrentContext()) {\n      const context = getCurrentContext()!;\n      return {\n        isOk: context.initSucceeded,\n        status: context.initStatus,\n        error: context.initError,\n        context,\n      };\n    }\n  } catch {\n    // `initialize` has not been run yet and so the current context doesn't\n    // exist. Let's go ahead and create one.\n  }\n\n  const {\n    streamingFlags = false,\n    localFlags = {},\n    timeout = 5,\n    mode: initialMode = 'local',\n    onStatusChange,\n    onError,\n    ...rest\n  } = options;\n  let mode = initialMode;\n\n  if (!['local', 'remote'].includes(mode)) {\n    warn(\n      `\"config.mode\" must be set to either \"local\" or \"remote\". Defaulting to \"local\". (Invalid value: \"${mode}\")`,\n      false,\n      { id: 'ember-launch-darkly.invalid-config-property.mode' },\n    );\n\n    mode = 'local';\n  }\n\n  if (mode === 'local') {\n    const context = new Context({\n      flags: localFlags,\n      initStatus: 'local',\n      onStatusChange,\n      onError,\n    });\n    setCurrentContext(context);\n\n    return { isOk: true, status: 'local', context };\n  }\n\n  options = {\n    sendEventsOnlyForVariation: true,\n    wrapperName: 'ember-launch-darkly',\n    wrapperVersion:\n      typeof __ADDON_VERSION__ !== 'undefined' ? __ADDON_VERSION__ : undefined,\n    ...rest,\n  };\n\n  if (options.bootstrap === 'localFlags' && localFlags != null) {\n    options.bootstrap = localFlags;\n  }\n\n  const client = LDClient.initialize(\n    clientSideId,\n    user,\n    options as LDClient.LDOptions,\n  );\n\n  let initStatus: InitStatus = 'initialized';\n  let initError: unknown;\n\n  try {\n    await client.waitForInitialization(timeout);\n  } catch (error) {\n    initStatus = 'failed';\n    initError = error;\n\n    warn(\n      `LaunchDarkly SDK failed to initialize within ${String(timeout)}s. Using ${options.bootstrap ? 'bootstrap' : 'default'} flag values. Error: ${String(error)}`,\n      false,\n      { id: 'ember-launch-darkly.initialization-timeout' },\n    );\n  }\n\n  const flags = client.allFlags();\n\n  const context = new Context({\n    flags,\n    client,\n    initStatus,\n    initError,\n    onStatusChange,\n    onError,\n  });\n\n  // Set context globally *before* registering event handlers so that\n  // `getCurrentContext()` is available immediately â€” including when init\n  // failed. This prevents a second `initialize()` call from creating a\n  // duplicate client and ensures post-init recovery works automatically.\n  setCurrentContext(context);\n\n  client.on('error', (error: Error) => {\n    context.handleError(error);\n  });\n\n  client.on('change', (updates: Record<string, unknown>) => {\n    // If we receive flag changes after a failed init, the SDK has recovered.\n    // Transition to 'initialized' so the app can react.\n    if (context.initStatus === 'failed') {\n      context.transitionStatus('initialized');\n    }\n\n    const flagsToUpdate: Record<string, unknown> = {};\n    // @ts-expect-error TODO: fix this type error\n    for (const [key, { current }] of Object.entries(updates)) {\n      if (shouldUpdateFlag(key, streamingFlags)) {\n        flagsToUpdate[key] = current;\n      }\n    }\n\n    context.updateFlags(flagsToUpdate);\n  });\n\n  return {\n    isOk: initStatus === 'initialized',\n    status: initStatus,\n    error: initError,\n    context,\n  };\n}\n"],"names":["shouldUpdateFlag","key","streamingConfig","allExcept","Array","isArray","includes","initialize","clientSideId","user","options","getCurrentContext","context","isOk","initSucceeded","status","initStatus","error","initError","streamingFlags","localFlags","timeout","mode","initialMode","onStatusChange","onError","rest","warn","id","Context","flags","setCurrentContext","sendEventsOnlyForVariation","wrapperName","wrapperVersion","bootstrap","client","LDClient","waitForInitialization","String","allFlags","on","handleError","updates","transitionStatus","flagsToUpdate","current","Object","entries","updateFlags"],"mappings":"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"}